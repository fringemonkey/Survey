name = "tlcsurvey"
compatibility_date = "2024-01-01"

# Pages configuration - this tells Cloudflare this is a Pages project
pages_build_output_dir = "dist"

# Explicitly disable Worker mode
# Do NOT include a "main" field - that would make it a Worker
# The /functions directory contains Pages Functions, not a Worker script

# IMPORTANT: All bindings below are managed by wrangler when deploying with:
#   npx wrangler pages deploy dist --project-name survey
# 
# When bindings are managed by wrangler, they will show as "configured by wrangler"
# in the Cloudflare Dashboard and cannot be changed via the UI.
# 
# To change bindings, update this file and redeploy with wrangler.
# 
# NOTE: If you want to use Git-based deployments instead, remove bindings from
# this file and configure them manually in Cloudflare Dashboard.

# ============================================================================
# PRODUCTION ENVIRONMENT CONFIGURATION
# ============================================================================
# Default configuration applies to production environment
# Deploy with: npx wrangler pages deploy dist --project-name survey

# D1 Database bindings - Production
[[d1_databases]]
binding = "DB_STAGING"
database_name = "tlc-survey-db-staging"
database_id = "e556fdc3-22c6-4c8c-800b-31498ad9d8ad" # Production staging DB

[[d1_databases]]
binding = "DB_PROD"
database_name = "tlc-survey-db-prod"
database_id = "b2b381f0-8a93-4bb0-b60e-ceed029e4c45" # Production DB

# Legacy binding for backward compatibility
[[d1_databases]]
binding = "DB"
database_name = "tlc-survey-db"
database_id = "e556fdc3-22c6-4c8c-800b-31498ad9d8ad"

# KV Namespace for rate limiting - Production
[[kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "e93a364198744d5d9b51cbcfb28b127f" # Production namespace
preview_id = "49aede8c4a55460e85cafc010d52da83" # Preview namespace for local development

# Environment variables - Production
[vars]
# Rate limiting configuration
RATE_LIMIT_PER_HOUR = "10"
# Environment identifier
ENVIRONMENT = "production"

# ============================================================================
# SANDBOX/PREVIEW ENVIRONMENT CONFIGURATION
# ============================================================================
# Sandbox environment for dev.gamesurvey.cocstlc.org
# Deploy with: npx wrangler pages deploy dist --project-name survey --branch dev
# Or use custom environment: npx wrangler pages deploy dist --project-name survey --env preview

[env.preview]
# Sandbox D1 Database bindings
[[env.preview.d1_databases]]
binding = "DB_STAGING"
database_name = "tlc-survey-db-sandbox-staging"
database_id = "" # TODO: Create with: wrangler d1 create tlc-survey-db-sandbox-staging

[[env.preview.d1_databases]]
binding = "DB_PROD"
database_name = "tlc-survey-db-sandbox-prod"
database_id = "" # TODO: Create with: wrangler d1 create tlc-survey-db-sandbox-prod

[[env.preview.d1_databases]]
binding = "DB"
database_name = "tlc-survey-db-sandbox"
database_id = "" # TODO: Create with: wrangler d1 create tlc-survey-db-sandbox (or reuse staging)

# Sandbox KV Namespace for rate limiting
[[env.preview.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "" # TODO: Create with: wrangler kv namespace create RATE_LIMIT_KV_SANDBOX
preview_id = "49aede8c4a55460e85cafc010d52da83" # Can reuse preview namespace

# Sandbox environment variables
[env.preview.vars]
# More lenient rate limiting for sandbox
RATE_LIMIT_PER_HOUR = "50"
# Environment identifier
ENVIRONMENT = "sandbox"

# Required: Admin password for all protected API endpoints
# ADMIN_PASSWORD = "" # Set via: wrangler pages secret put ADMIN_PASSWORD --project-name survey
# 
# Authentication uses server-side sessions stored in KV (RATE_LIMIT_KV or optional SESSION_KV)
# Password is NEVER stored client-side - only session tokens in HttpOnly cookies
# 
# All API endpoints except /api/submit are protected with server-side session authentication
# Protected endpoints: /api/dashboard, /api/admin/*, /api/sanitize, /api/backup, /api/sync-to-notion
# Cron triggers bypass authentication automatically

# Optional: Notion integration (set via Cloudflare Dashboard secrets if using Notion)
# VITE_NOTION_API_KEY = "" # Set via: wrangler secret put VITE_NOTION_API_KEY
# VITE_NOTION_DB_1 = ""
# VITE_NOTION_DB_2 = ""
# VITE_NOTION_DB_3 = ""
# VITE_NOTION_DB_4 = ""
# VITE_NOTION_DB_5 = ""

# Note: Cron triggers for Pages Functions
# Cron triggers MUST be configured in Cloudflare Dashboard (they cannot be set via wrangler.toml)
# Go to: Pages → survey → Settings → Functions → Cron Triggers
# 
# Recommended cron triggers:
# - "0 * * * *" (hourly) → /api/sanitize (backup sanitization job for failed records)
# - "0 0 * * *" (daily) → /api/backup (backup job)
# 
# NOTE: Sanitization runs immediately on each submission. The cron job is a backup
# to catch any records that failed immediate sanitization.
# 
# Deploy with wrangler (bindings are automatically applied from this file):
#   npm run build
#   npx wrangler pages deploy dist --project-name survey
# 
# Set secrets (do this once, secrets are separate from bindings):
#   npx wrangler pages secret put BACKUP_SECRET --project-name survey
#   npx wrangler pages secret put SANITIZE_SECRET --project-name survey
#   npx wrangler pages secret put ADMIN_PASSWORD --project-name survey

