name = "tlcsurvey"
compatibility_date = "2024-01-01"

# Pages configuration - this tells Cloudflare this is a Pages project
pages_build_output_dir = "dist"

# Explicitly disable Worker mode
# Do NOT include a "main" field - that would make it a Worker
# The /functions directory contains Pages Functions, not a Worker script

# IMPORTANT: All bindings below are managed by wrangler when deploying with:
#   npx wrangler pages deploy dist --project-name tlc-survey
# 
# When bindings are managed by wrangler, they will show as "configured by wrangler"
# in the Cloudflare Dashboard and cannot be changed via the UI.
# 
# To change bindings, update this file and redeploy with wrangler.
# 
# NOTE: If you want to use Git-based deployments instead, remove bindings from
# this file and configure them manually in Cloudflare Dashboard.

# ============================================================================
# PRODUCTION ENVIRONMENT CONFIGURATION
# ============================================================================
# Default configuration applies to production environment
# Deploy with: npx wrangler pages deploy dist --project-name tlc-survey

# D1 Database bindings - Production
[[d1_databases]]
binding = "DB_STAGING"
database_name = "tlc-survey-db-staging"
database_id = "e556fdc3-22c6-4c8c-800b-31498ad9d8ad" # Production staging DB

[[d1_databases]]
binding = "DB_PROD"
database_name = "tlc-survey-db-prod"
database_id = "b2b381f0-8a93-4bb0-b60e-ceed029e4c45" # Production DB

# Legacy binding for backward compatibility
[[d1_databases]]
binding = "DB"
database_name = "tlc-survey-db"
database_id = "e556fdc3-22c6-4c8c-800b-31498ad9d8ad"

# KV Namespace for rate limiting - Production
[[kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "e93a364198744d5d9b51cbcfb28b127f" # Production namespace
preview_id = "49aede8c4a55460e85cafc010d52da83" # Preview namespace for local development

# Environment variables - Production
[vars]
# Rate limiting configuration
RATE_LIMIT_PER_HOUR = "10"
# Environment identifier
ENVIRONMENT = "production"

# ============================================================================
# SANDBOX/PREVIEW ENVIRONMENT CONFIGURATION
# ============================================================================
# Sandbox environment for dev.gamesurvey.cocstlc.org
# Deploy with: npx wrangler pages deploy dist --project-name tlc-survey --branch dev
# Or use preview branch: npx wrangler pages deploy dist --project-name tlc-survey --branch preview
# Note: The [env.preview] configuration is automatically applied to preview deployments

[env.preview]
# Sandbox D1 Database bindings
[[env.preview.d1_databases]]
binding = "DB_STAGING"
database_name = "tlc-survey-db-sandbox-staging"
database_id = "e76a1d4f-e575-41b2-958b-7640221255d8"

[[env.preview.d1_databases]]
binding = "DB_PROD"
database_name = "tlc-survey-db-sandbox-prod"
database_id = "7736b5d2-a16f-40af-be64-720830668ff1"

[[env.preview.d1_databases]]
binding = "DB"
database_name = "tlc-survey-db-sandbox"
database_id = "e2c5f793-38f6-40fc-bff9-7d6039d86375"

# Sandbox KV Namespace for rate limiting
[[env.preview.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "6ea0a02a887b4d1fb7429e6ce348a82c"
preview_id = "49aede8c4a55460e85cafc010d52da83" # Can reuse preview namespace

# Sandbox environment variables
[env.preview.vars]
# More lenient rate limiting for sandbox
RATE_LIMIT_PER_HOUR = "50"
# Environment identifier
ENVIRONMENT = "sandbox"

# Authentication: Cloudflare Zero Trust Access (primary) with password auth fallback (during migration)
# 
# PRIMARY: Cloudflare Zero Trust Access with GitHub identity provider
# - Admin panel and dev site protected via Cloudflare Access applications
# - Authentication handled at edge level - no client-side password storage
# - CF-Access-JWT-Assertion header automatically added for authenticated requests
# 
# FALLBACK (during migration): Password-based authentication
# ADMIN_PASSWORD = "" # DEPRECATED - Set via: wrangler pages secret put ADMIN_PASSWORD --project-name survey
# - Server-side sessions stored in KV (RATE_LIMIT_KV or optional SESSION_KV)
# - Password is NEVER stored client-side - only session tokens in HttpOnly cookies
# - Will be removed after Zero Trust migration is complete
# 
# All API endpoints except /api/submit are protected
# Protected endpoints: /api/dashboard, /api/admin/*, /api/sanitize, /api/backup, /api/sync-to-notion
# All protected endpoints require authentication (Zero Trust or password-based)

# Optional: Notion integration (set via Cloudflare Dashboard secrets if using Notion)
# NOTION_API_KEY = "" # Set via: wrangler secret put NOTION_API_KEY
# NOTION_DB_1 = ""
# NOTION_DB_2 = ""
# NOTION_DB_3 = ""
# NOTION_DB_4 = ""
# NOTION_DB_5 = ""

# Manual Operations:
# - Sanitization runs automatically after each submission completion
# - Manual backup and sanitize operations available via admin panel buttons
# - No cron triggers or secrets (BACKUP_SECRET, SANITIZE_SECRET) required
# - Operations use authentication instead of secrets
# 
# Deploy with wrangler (bindings are automatically applied from this file):
#   npm run build
#   npx wrangler pages deploy dist --project-name tlc-survey
# 
# For preview/sandbox environment:
#   npm run deploy:preview
#   or: npx wrangler pages deploy dist --project-name tlc-survey --branch preview
# Note: Preview deployments automatically use [env.preview] configuration
